# 스테이지별 백테스팅 분석 및 프로세스 검토

**작성일**: 2025-12-19
**분석 기간**: 2025-06-01 ~ 2025-10-31
**초기 자본**: 10,000,000원

---

## 1. 백테스팅 결과 요약

### 기존 전략 성과 (Stage 6 강화 전)

| 지표 | 값 |
|-----|-----|
| **총 수익률** | 21.24% |
| **최종 자본** | 12,124,165원 |
| **승률** | 50.00% (25/50) |
| **총 거래 수** | 50건 |
| **최대 낙폭 (MDD)** | 2.33% |

### 스테이지별 성과 분석

| 스테이지 | 거래 수 | 승률 | 평균 수익 | 특징 |
|---------|--------|------|---------|------|
| **Stage 3** | 17건 | **100%** | 매우 높음 | 하락 변화기2, 100% 성공 |
| **Stage 6** | 33건 | **24.2%** | 낮음 | 상승 변화기2, 75.8% 실패 |

**핵심 발견**:
- Stage 3: 하락 반전 포착에 매우 효과적 (100% 승률)
- Stage 6: 상승 변화기의 불확실성으로 인한 높은 실패율 (75.8%)

---

## 2. Stage 6 강화 시도 및 실패

### 시도한 개선 방안

**Stage 6 진입 조건 강화**:
```python
# 추가 조건 (실패)
if check_ema_slope and target_stage == 6:
    # 장기선(EMA_40) 평행 확인
    ema_40_flat = data['Slope_EMA_40'].abs() < 0.5
    # 단기선/중기선 상승 확인
    ema_5_up = data['Slope_EMA_5'] > 0.0
    ema_20_up = data['Slope_EMA_20'] > 0.0

    # 모든 조건 충족 시에만 진입
    ema_slope_condition = ema_40_flat & ema_5_up & ema_20_up
```

**Stage 3 진입 조건 완화**:
```python
# Stage별 임계값 적용
if stage_based_threshold and 'Stage' in data.columns:
    is_stage_3 = data['Stage'] == 3
    stage_3_passed = data['Signal_Strength'] >= 0  # 모든 신호 허용
    passed = passed | (is_stage_3 & stage_3_passed)
```

### 개선 후 결과 (실패)

| 지표 | 개선 전 | 개선 후 | 변화 |
|-----|--------|--------|------|
| **총 수익률** | 21.24% | 17.22% | ⬇️ -4.02%p |
| **승률** | 50.00% | 70.97% | ⬆️ +20.97%p |
| **Stage 6 거래** | 33건 (24.2% 승률) | 8건 (0% 승률) | ❌ 완전 실패 |
| **Stage 3 거래** | 17건 (100% 승률) | 23건 (95.7% 승률) | ✅ 성공 |

**실패 원인 분석**:
1. **Stage 6 과도한 필터링**:
   - 33건 → 8건으로 감소 (75.8% 필터링)
   - 수익 거래 8건이 모두 필터링됨
   - 손실 거래만 8건 남음 → 0% 승률

2. **전략 문서 오해**:
   - "조기 주문 검토 조건"은 Stage 6 이전 단계용
   - Stage 6 자체는 단순 조건: MACD(중) -→0 + 3 MACDs 상승

3. **Stage 3 완화는 성공**:
   - 17건 → 23건 (35% 증가)
   - 95.7% 승률 유지 (17/23건 성공)

---

## 3. 전략 문서 재분석

### Stage 6의 본질

**문서 인용** (Moving_Average_Investment_Strategy_Summary.md):

> **제6스테이지: 상승 변화기2**
> - 위치: "상승장의 입구" (NOT 상승장 자체)
> - 특성: 변화기 (이행기), 불확실성 높음
> - 경고: "이행기에서 무리한 포지션 확대 금지"

**핵심 이해**:
- Stage 6 = 상승장의 "입구"이지 상승장이 아님
- 변화기이므로 본질적으로 불확실성 높음
- 75.8% 실패율은 구조적 문제

### Stage 1 vs Stage 6 비교

| 항목 | Stage 6 (상승 변화기2) | Stage 1 (안정 상승기) |
|------|---------------------|------------------|
| **시장 국면** | 상승장의 "입구" | 상승장 "확정" |
| **배열** | 단기 > 장기 > 중기 (불완전) | 단기 > 중기 > 장기 (완전 정배열) |
| **MACD 신호** | MACD(중) -→0 (골든크로스2) | MACD(하) -→0 (골든크로스3) |
| **추세 강도** | 약함 (변화기) | 강함 (안정기) |
| **문서 권고** | "무리한 포지션 확대 금지" | "공격적인 매수 진행" |
| **기대 승률** | 낮음 (실제 25%) | 높음 (안정된 추세) |
| **현재 구현** | ✅ 구현됨 | ❌ 미구현 |

**문서 인용** (lines 313-315):
> **제1스테이지 진입**: 상승 확정 시점, 놓치지 말아야 할 매수 기회

**문서 인용** (lines 335-337):
> 제1스테이지(상승 확정) 또는 제4스테이지(하락 확정) 진입 시점을 놓치지 말 것
> **이 시기가 가장 큰 수익을 낼 수 있는 구간**
> 망설임 없이 포지션 진입 필요

---

## 4. 현재 스테이지별 프로세스 현황

### 진입 신호 구현 현황

| 스테이지 | 시장 국면 | 구현 여부 | 진입 조건 | 신호 타입 |
|---------|---------|----------|---------|---------|
| **Stage 1** | 안정 상승기 | ❌ **미구현** | - | - |
| **Stage 2** | 하락 변화기1 | ✅ 구현됨 | Stage 2 + 3 MACDs 하락 | 조기 매도 |
| **Stage 3** | 하락 변화기2 | ✅ 구현됨 | Stage 3 + 3 MACDs 하락 | 통상 매도 |
| **Stage 4** | 안정 하락기 | ❌ **미구현** | - | - |
| **Stage 5** | 상승 변화기1 | ✅ 구현됨 | Stage 5 + 3 MACDs 상승 | 조기 매수 |
| **Stage 6** | 상승 변화기2 | ✅ 구현됨 | Stage 6 + 3 MACDs 상승 | 통상 매수 |

**코드 위치**: `src/analysis/signal/entry.py`

### 청산 신호 (모든 스테이지 공통)

**3단계 순차적 청산** (`strategy='sequential'`):

| 레벨 | 조건 | 청산 비율 | 목적 |
|-----|------|---------|------|
| **Level 1** | MACD_상 히스토그램 피크아웃 | 0% | 경계 모드 |
| **Level 2** | MACD_중 MACD선 피크아웃 | 50% | 절반 청산 |
| **Level 3** | MACD_하 교차 | 100% | 전량 청산 |

**코드 위치**: `src/analysis/signal/exit.py`

### 신호 필터링 (모든 스테이지 공통)

**4가지 필터**:
1. **강도 필터**: Signal_Strength >= 50점
2. **변동성 필터**: ATR 상위 10% 제외
3. **추세 필터**: Slope_EMA_40 >= 0.1
4. **상충 필터**: 진입-청산 동시 발생 제거

**코드 위치**: `src/analysis/signal/filter.py`

---

## 5. 핵심 발견 및 결론

### 발견 사항

1. **Stage 1/4가 미구현됨**:
   - 안정기 (가장 수익성 높은 구간) 진입 로직 부재
   - 현재는 변화기(2,3,5,6)만 거래 중

2. **Stage 6의 구조적 한계**:
   - 변화기의 불확실성으로 인한 낮은 승률 (24.2%)
   - 빠른 손절로 손실 제한 (MDD 2.33%)
   - 강화 시도는 역효과 (모든 수익 거래 필터링)

3. **Stage 3의 우수성**:
   - 하락 반전 포착에 매우 효과적 (100% 승률)
   - 1-5일 내 빠른 반등 포착

### 결정 사항

1. **Stage 6**: 기존 전략 유지
   - 강화 없이 원래대로 사용
   - 빠른 손절이 손실 제한 역할

2. **Stage 3**: 완화 전략 유지 (선택적)
   - 신호 강도 임계값 낮춤
   - 더 많은 기회 포착 가능

3. **Stage 1**: 새로운 구현 필요
   - 안정 상승기 진입 로직 추가
   - Stage 6 대체 또는 보완 전략으로 활용

---

## 6. 다음 단계

### 우선순위 1: Stage 1 구현

**목적**: 안정된 상승 추세에서 높은 승률 달성

**기대 효과**:
- Stage 6 (변화기, 25% 승률) → Stage 1 (안정기, 예상 60%+ 승률)
- 명확한 추세에서 진입하여 리스크 감소
- 전략 문서 권고사항 준수

### 우선순위 2: 백테스팅 비교

- Stage 1 단독 성과
- Stage 6 단독 성과
- Stage 1 + Stage 6 조합 성과
- 최적 전략 결정

---

## 참고 자료

- 전략 문서: `Moving_Average_Investment_Strategy_Summary.md`
- 코드 구현: `src/analysis/signal/entry.py`, `exit.py`, `filter.py`
- 백테스트 엔진: `src/backtest/engine.py`
- 분석 도구: `src/backtest/analytics.py`
# 공통 모듈 설계 및 개발 계획

## 날짜
2025-10-30

## 배경 및 목적

### 프로젝트 구조 분석
본 프로젝트는 크게 두 가지 실행 프로세스로 구성됩니다:

1. **strategy/** - 실시간 전략 실행
   - 특정 시간에 실행 (예: cron job)
   - 조건을 만족하는 종목 스크리닝
   - 실시간 매수/매도 주문 실행
   
2. **backtest/** - 백테스팅 엔진
   - 과거 데이터 기반 시뮬레이션
   - 전체 기간 동안 전략 반복 실행
   - 성과 분석 및 리포트 생성

### 공통 로직 식별

두 프로세스 모두에서 **동일하게 사용되는 로직**:
1. 주가 데이터 수집
2. 이동평균선 계산 (5일, 20일, 40일)
3. MACD 3종 조합 계산 (5|20|9, 5|40|9, 20|40|9)
4. 6단계 스테이지 판단
5. 포지션 사이징 (1유닛 계산)
6. 리스크 관리 (손절/익절 라인)

### 설계 원칙
- **DRY (Don't Repeat Yourself)**: 중복 코드 제거
- **단일 책임 원칙**: 각 모듈은 하나의 명확한 책임
- **의존성 역전**: 상위 모듈이 하위 모듈에만 의존
- **테스트 용이성**: 각 모듈을 독립적으로 테스트 가능
- **재사용성**: strategy와 backtest 모두에서 사용 가능

---

## 의존성 계층 구조

```
[Level 1] 데이터 수집
    ↓ (주가 데이터 제공)
[Level 2] 기술적 지표 계산
    ↓ (EMA, MACD, ATR 제공)
[Level 3] 스테이지 분석
    ↓ (현재 스테이지 제공)
[Level 4] 매매 신호 생성
    ↓ (진입/청산 신호 제공)
[Level 5] 리스크 관리
    ↓ (포지션 크기, 손절가 제공)
[Level 6] 실행 계층 (strategy / backtest)
```

**의존성 방향**: Level 1 ← Level 2 ← Level 3 ← Level 4 ← Level 5 ← Level 6
- 하위 레벨은 상위 레벨을 알지 못함
- 상위 레벨은 하위 레벨만 import
- 순환 참조 방지

---

## 개발 우선순위

### 1순위: 데이터 수집 모듈 ⭐⭐⭐
**경로**: `src/data/`

**이유**:
- 모든 계산의 기반이 되는 원시 데이터
- 다른 모듈들이 이 모듈에 의존
- 백테스트용 과거 데이터와 실시간 데이터의 인터페이스 통일 필요

**구성**:
```
src/data/
├── __init__.py
├── collector.py      # 주가 데이터 수집 인터페이스
└── processor.py      # 데이터 전처리 (결측치, 정렬 등)
```

**주요 기능**:
- HantuStock API 래핑 (실시간 데이터)
- 과거 데이터 수집 (FinanceDataReader, pykrx)
- 데이터 정규화 및 검증
- 통일된 DataFrame 형식 제공 (OHLCV)

---

### 2순위: 기술적 지표 계산 모듈 ⭐⭐⭐
**경로**: `src/analysis/technical/`

**이유**:
- 스테이지 판단의 직접적 입력값
- 독립적으로 테스트 가능한 순수 함수
- 가장 안정적이고 재사용성 높은 모듈

**구성**:
```
src/analysis/technical/
├── __init__.py
├── indicators.py     # 기술적 지표 계산 (EMA, MACD, ATR)
└── utils.py          # 보조 함수 (피크아웃 감지 등)
```

**주요 기능**:
- **EMA 계산**: 지수 이동평균 (5일, 20일, 40일)
- **MACD 3종 조합**:
  - MACD(상): 5|20|9
  - MACD(중): 5|40|9
  - MACD(하): 20|40|9
- **ATR 계산**: 포지션 사이징용 변동성 지표
- **히스토그램 & 시그널선**: MACD 구성 요소
- **피크아웃 감지**: 히스토그램/MACD선의 방향 전환 감지

---

### 3순위: 스테이지 분석 모듈 ⭐⭐
**경로**: `src/analysis/`

**이유**:
- 6단계 스테이지는 전략의 핵심 개념
- 이동평균선 배열 + MACD 0선 교차로 결정
- 매매 신호 생성의 기반

**구성**:
```
src/analysis/
├── __init__.py
└── stage.py          # 6단계 스테이지 판단 로직
```

**주요 기능**:
- 현재 스테이지 판단 (제1~제6스테이지)
- 스테이지 전환 감지
- 이동평균선 배열 분석
- MACD 0선 교차 감지

**스테이지 정의**:
| 스테이지 | 배열 | MACD 신호 | 시장 국면 |
|---------|------|---------|----------|
| 제1 | 단기>중기>장기 | MACD(하) -→0 | 안정 상승기 |
| 제2 | 중기>단기>장기 | MACD(상) +→0 | 하락 변화기1 |
| 제3 | 중기>장기>단기 | MACD(중) +→0 | 하락 변화기2 |
| 제4 | 장기>중기>단기 | MACD(하) +→0 | 안정 하락기 |
| 제5 | 장기>단기>중기 | MACD(상) -→0 | 상승 변화기1 |
| 제6 | 단기>장기>중기 | MACD(중) -→0 | 상승 변화기2 |

---

### 4순위: 매매 신호 생성 모듈 ⭐⭐
**경로**: `src/analysis/signal/`

**이유**:
- 스테이지와 MACD 방향성을 조합하여 신호 생성
- 진입/청산 타이밍 결정
- 전략의 핵심 로직

**구성**:
```
src/analysis/signal/
├── __init__.py
└── generator.py      # 매매 신호 생성
```

**주요 기능**:
- **매수 신호**:
  - 통상 매수: 제6스테이지 + 3개 MACD 우상향
  - 조기 매수: 제5스테이지 + 3개 MACD 우상향
- **매도 신호**:
  - 통상 매도: 제3스테이지 + 3개 MACD 우하향
  - 조기 매도: 제2스테이지 + 3개 MACD 우하향
- **청산 신호 (3단계)**:
  1. 히스토그램 피크아웃 → 경계 태세
  2. MACD선 피크아웃 → 50% 청산
  3. MACD-시그널 교차 → 100% 청산

---

### 5순위: 리스크 관리 모듈 ⭐
**경로**: `src/risk/`

**이유**:
- 실제 매매 수량 결정
- 손절/익절 라인 계산
- 포지션 제한 관리

**구성**:
```
src/risk/
├── __init__.py
├── position.py       # 포지션 사이징
└── manager.py        # 리스크 통제
```

**주요 기능**:
- **포지션 사이징**:
  ```
  1유닛 = (계좌잔고 × 1%) / ATR
  ```
- **손절 라인**:
  - 추세 기반: 데드크로스/골든크로스 가격
  - 변동성 기반: 진입가 ± 2×ATR
- **포지션 제한**:
  - 동일 종목: 최대 4유닛
  - 상관 높은 종목: 최대 6유닛
  - 상관 낮은 종목: 최대 10유닛
  - 전체 포지션: 최대 12유닛
- **트레일링 스톱**: 최고가/최저가 기준 2ATR

---

## 최종 프로젝트 구조

```
src/
├── data/                  # [Level 1] 데이터 계층
│   ├── __init__.py
│   ├── collector.py       # 주가 데이터 수집 인터페이스
│   └── processor.py       # 데이터 전처리
│
├── analysis/              # [Level 2-4] 분석 계층
│   ├── __init__.py
│   │
│   ├── technical/         # [Level 2] 기술적 지표
│   │   ├── __init__.py
│   │   ├── indicators.py  # EMA, MACD, ATR 계산
│   │   └── utils.py       # 보조 함수 (피크아웃 등)
│   │
│   ├── stage.py           # [Level 3] 스테이지 판단
│   │
│   └── signal/            # [Level 4] 매매 신호
│       ├── __init__.py
│       └── generator.py   # 진입/청산 신호 생성
│
├── risk/                  # [Level 5] 리스크 관리 계층
│   ├── __init__.py
│   ├── position.py        # 포지션 사이징 (유닛 계산)
│   └── manager.py         # 리스크 통제 (손절/익절)
│
├── strategy/              # [Level 6] 실시간 실행
│   ├── __init__.py
│   └── strategy.py        # 공통 모듈 조합 → 실시간 매매
│
└── backtest/              # [Level 6] 백테스팅
    ├── __init__.py
    └── engine.py          # 공통 모듈 조합 → 과거 시뮬레이션
```

---

## 개발 진행 방식

### 단계별 개발
1. **설계 검토**: 모듈 인터페이스 정의
2. **구현**: 실제 코드 작성
3. **단위 테스트**: pytest로 각 함수 테스트
4. **통합 테스트**: 상위 모듈과 연동 테스트
5. **문서화**: docstring 및 사용 예시 작성

### 테스트 전략
- 각 레벨별로 독립적인 테스트 파일 작성
- Mock 데이터 사용으로 외부 의존성 제거
- 엣지 케이스 테스트 (결측치, 0값, 음수 등)
- 성능 테스트 (대용량 데이터 처리)

### 코드 품질 관리
- **타입 힌팅**: 모든 함수에 타입 명시
- **Docstring**: Google 스타일 docstring
- **에러 처리**: 명확한 예외 메시지
- **로깅**: 디버깅용 로그 추가

---

## 다음 단계

### 즉시 시작: Level 1 - 데이터 수집 모듈
1. `src/data/collector.py` 인터페이스 설계
2. HantuStock API 래핑
3. 과거 데이터 수집 기능 (FinanceDataReader)
4. 데이터 검증 로직
5. 단위 테스트 작성

### 이후 순서
1. Level 2: 기술적 지표 계산
2. Level 3: 스테이지 분석
3. Level 4: 매매 신호 생성
4. Level 5: 리스크 관리
5. Level 6: strategy 및 backtest 통합

---

## 예상 일정

| 모듈 | 예상 소요 | 우선순위 |
|------|----------|---------|
| 데이터 수집 | 1일 | ⭐⭐⭐ |
| 기술적 지표 | 1-2일 | ⭐⭐⭐ |
| 스테이지 분석 | 1일 | ⭐⭐ |
| 매매 신호 | 1일 | ⭐⭐ |
| 리스크 관리 | 1일 | ⭐ |
| **총계** | **5-6일** | - |

*실제 소요 시간은 테스트 및 디버깅 시간에 따라 변동 가능*

---

## 주의사항

### 데이터 일관성
- 모든 데이터는 DataFrame 형태로 통일
- 컬럼명: `Open`, `High`, `Low`, `Close`, `Volume`
- 인덱스: `datetime` 타입
- 정렬: 날짜 오름차순

### 성능 고려
- pandas vectorization 활용
- 불필요한 반복문 최소화
- 대용량 데이터 처리 시 메모리 관리

### 에러 처리
- API 호출 실패 시 재시도 로직
- 데이터 누락 시 적절한 에러 메시지
- 계산 불가능한 경우 (충분한 데이터 없음) 명확한 예외

---

## 참고 문서

- [이동평균선 투자법 전략 정리](../../Moving_Average_Investment_Strategy_Summary.md)
- [API 연동 및 테스트](../2025-10-15_api_integration_and_testing.md)
- [프로젝트 README](../../README.md)

---

## 작성자
- seunghakim
- AI Assistant (Claude)

## 검토 이력
- 2025-10-30: 초안 작성 및 승인
